<?php
$incdir = '../inc';
set_include_path("$incdir");
require_once('funcs.inc.php');
require_once('db.inc.php');
header('Content-Type: application/json');

$arr = array();
$json = '{'; # begin json

$db_handle = pg_connect(
  "dbname=$db_name
   host=$db_host
   port=$db_port
   user=$db_ro_user
   password=$db_ro_pass
");

if ($db_handle) {
  #
  # =====================================
  # grid array
  # =====================================
  $grid_qry = "select col_id, row_id, status from grid order by col_id, row_id";
  $grid_rslt = pg_query($db_handle, $grid_qry);
  if ($grid_rslt) {
    $cur = 0;
    $num = pg_num_rows($grid_rslt);

    $json .= "\"theGrid\":[";
    while ($grid = pg_fetch_row($grid_rslt)) {
      if(++$cur === $num) {
        # last row, no comma
        $json .= "{\"coord\":\"".$grid[0].$grid[1]."\",\"status\":\"".$grid[2]."\"}";
      } else {
        # not the last row, add comma
        $json .= "{\"coord\":\"".$grid[0].$grid[1]."\",\"status\":\"".$grid[2]."\"},";
      }
    }
    $json .= "],"; # end of grid array
  } else {
    $arr[] = array("err" => "col_qry failed" . pg_last_error($db_handle));
    echo json_encode($arr);
    echo pg_result_error($rslt);
  }

  # =====================================
  # top 5 scores array
  # =====================================
  $score_qry = "select team_name, score_tally from reg, score where team_id = score_team order by score_tally desc, team_name asc limit 5";
  $score_rslt = pg_query($db_handle, $score_qry);
  if ($score_rslt) {
    $cur = 0;
    $num = pg_num_rows($score_rslt);

    $json .= "\"scores\":[";
    while ($score = pg_fetch_row($score_rslt)) {
      if(++$cur === $num) {
        # last row, no comma
        $json .= "{\"team_name\":\"".$score[0]."\",\"team_score\":".$score[1]."}";
      } else {
        # not the last row, add comma
        $json .= "{\"team_name\":\"".$score[0]."\",\"team_score\":".$score[1]."},";
      }
    }
    $json .= "]"; # end of scores arary
  } else {
    $arr[] = array("err" => "col_qry failed" . pg_last_error($db_handle));
    echo json_encode($arr);
    echo pg_result_error($rslt);
  }

  pg_close($db_handle);

  $json .= "}"; # end of json
  echo $json;

} else {
  $arr[] = array("err" => "db connection failed" . pg_last_error($db_handle));
  echo json_encode($arr);
}

?>
